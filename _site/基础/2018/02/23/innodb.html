<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>InnoDB存储引擎 - </title>
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="canonical" href="/%E5%9F%BA%E7%A1%80/2018/02/23/innodb.html">
	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
	<meta name="keywords" content="InnoDB存储引擎, , ">
	<meta name="description" content="">
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/html5shiv.js"></script>
	<script src="/js/holder.min.js"></script>
	<script src="/js/respond.js"></script>
	<script src="/js/application.js"></script>
	<script src="/js/lessismore.js"></script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

<body class="index">

<header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">主页</a>
        </li>
        <li>
          <a href="/categories/">类别</a>
        </li>
        <li>
          <a href="/tags">标签</a>
        </li>
      </ul>

    </nav>
  </div>

</header>
<div class="docs-header" id="content">
  <div class="container">
  	
		    <h1></h1>
      <p>不积跬步，无以至千里</p>
      
  </div>
</div>
<!---->
<!--<div class="banner">
    <div class="container">
        
        <a href="/categories/#基础-ref">基础</a>
        /
        <a href="/tags/#mysql-ref">mysql</a>
        
    </div>
</div>
-->
<!---->

<div class="container docs-container">
    <div class="row">
        <div class="col-md-3">
        <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
    <h1>目录</h1>
    <ul class="nav sidenav">
        
        
        
        
        
        
        <li><a href="#year_2019">2019</a>
            <ul class="nav">
                <li><a href="#month_2019_02">02</a></li>
                
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2018">2018</a>
        <ul class="nav">
            <li><a href="#month_2018_11">11</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_10">10</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_07">07</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_06">06</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_05">05</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_04">04</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_03">03</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_02">02</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_01">01</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2017">2017</a>
        <ul class="nav">
            <li><a href="#month_2017_12">12</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_11">11</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
            </ul>
        </li>
        
            
        </ul>
</div>



        </div>
        </div>
        <div class="col-md-9" role="main">
            <div class="panel docs-content">
            <div class="wrapper">
                <header class="post-header">
                    <h1 class="post-title">InnoDB存储引擎</h1>
                    <div class="meta"><span class="postdate">2018-02-23 16:21:09</span></div>
                    <br/>
                </header>
                <article class="post-content">
                    <ul id="markdown-toc">
  <li><a href="#mysql体系结构" id="markdown-toc-mysql体系结构">MySQL体系结构</a>    <ul>
      <li><a href="#innodb存储引擎特点" id="markdown-toc-innodb存储引擎特点">InnoDB存储引擎特点</a></li>
      <li><a href="#myisam存储引擎特点" id="markdown-toc-myisam存储引擎特点">MyISAM存储引擎特点</a></li>
    </ul>
  </li>
  <li><a href="#存储" id="markdown-toc-存储">存储</a>    <ul>
      <li><a href="#内存结构" id="markdown-toc-内存结构">内存结构</a></li>
      <li><a href="#聚集索引索引和非聚集索引" id="markdown-toc-聚集索引索引和非聚集索引">聚集索引索引和非聚集索引</a></li>
      <li><a href="#插入缓冲" id="markdown-toc-插入缓冲">插入缓冲</a></li>
      <li><a href="#两次写" id="markdown-toc-两次写">两次写</a></li>
      <li><a href="#自适应哈希" id="markdown-toc-自适应哈希">自适应哈希</a></li>
    </ul>
  </li>
  <li><a href="#表" id="markdown-toc-表">表</a>    <ul>
      <li><a href="#表结构" id="markdown-toc-表结构">表结构</a></li>
    </ul>
  </li>
  <li><a href="#锁" id="markdown-toc-锁">锁</a>    <ul>
      <li><a href="#一致性的非锁定行读" id="markdown-toc-一致性的非锁定行读">一致性的非锁定行读</a></li>
      <li><a href="#锁的类型" id="markdown-toc-锁的类型">锁的类型</a></li>
    </ul>
  </li>
  <li><a href="#事务" id="markdown-toc-事务">事务</a></li>
  <li><a href="#日志" id="markdown-toc-日志">日志</a></li>
</ul>

<p>前段时间看的《MySQL技术内幕：InnoDB存储引擎》,对关键的地方做个总结</p>

<h1 id="mysql体系结构">MySQL体系结构</h1>

<p><img src="/_pic/201712/mysql_struct.jpeg" alt="" /></p>

<h2 id="innodb存储引擎特点">InnoDB存储引擎特点</h2>

<p>基于表
支持事务，用于在线事务处理（OLTP），行锁，支持外键
高并发，且支持SQL的四种隔离级别
通过聚集方式存储数据，也就是每张表的数据按照主键进行顺序存储</p>

<h2 id="myisam存储引擎特点">MyISAM存储引擎特点</h2>

<p>不支持事务、表锁设计</p>

<hr />

<h1 id="存储">存储</h1>

<h2 id="内存结构">内存结构</h2>

<p><img src="/_pic/201802/InnoDB-store.png" alt="" /></p>

<h2 id="聚集索引索引和非聚集索引">聚集索引索引和非聚集索引</h2>

<p>这是一个数据库名词,聚集索引(clusteredindex)表示索引的逻辑顺序和表中相应行的物理顺序一致;而非聚集索引(nonclusteredindex)则表示不一致.
Mysql 没有聚集索引的概念,InnoDB引擎的主键是按照聚集索引的方式存放的.</p>

<h2 id="插入缓冲">插入缓冲</h2>

<p>数据页的存放按照聚集索引(也就是主键)的执行顺序存放，但非聚集索引的叶子节点需要离散地访问非聚集索引页，导致插入性能变低；为了解决这个问题，InnoDB设计了插入缓冲。非聚集索引的插入或更新操作，先判断插入的非聚集索引页是否在缓冲池中。如果在，直接插入索引页；否则，先放入插入缓冲区中，然后再以一定的频率执行插入缓冲和非聚集索引页子节点的合并操作。这样多个插入在一个索引页，可以合并到一个操作中。  <br />
插入缓冲的使用条件：非聚集索引&amp;非唯一索引</p>

<h2 id="两次写">两次写</h2>

<p>缓冲池的脏页刷新到磁盘文件之前，会先拷贝到内存中的doublewritebuffer（2M），然后通过doublewritebuffer分两次写入到物理磁盘的共享表空间（每次1M）；然后后再把缓冲池的脏页同步到磁盘的数据文件中。通过这种操作保证了数据的可靠性.  <br />
表现在:当操作系统在将页写入磁盘的过程中崩溃,在恢复过程中,可以从共享表空间的doublewrite中找到页的一个副本,将其拷贝到表空间文件,再重做日志.避免了部分数据失效的情况.</p>

<h2 id="自适应哈希">自适应哈希</h2>

<p>InnoDB存储引擎会自动根据访问频率和模式为某些页建立哈希索引.   <br />
哈希索引只能用来搜索等值的查询,对于其他查找类型,如范围查找,是不能使用的.(show engine innodb status)</p>

<hr />

<h1 id="表">表</h1>

<h2 id="表结构">表结构</h2>

<p>主键默认指定的话怎么指定：1. 非空的唯一索引 2. 自动创建6字节的指针。</p>

<p>存储结构：</p>

<ul>
  <li>逻辑存储结构：所有数据被逻辑存放在一个空间中，即表空间。表空间分为段（segment）、区（extent）、页（page/block）组成</li>
  <li>物理存储结构：共享表空间、日志文件组、表结构定义文件</li>
</ul>

<p>行数据：
compact行数据:变长字段列表;null标示位,数据行头信息,列1…,事务ＩＤ(隐藏)，回滚指针（隐藏）</p>

<p>页内部通过链表结构串联各个行记录,每行的头部最后四个字节表示下一条记录的偏移量  <br />
页中存放的是具体的数据记录  <br />
数据页结构:</p>

<p><img src="/_pic/201802/innodb-page.png" alt="" /></p>

<p>关系型数据库的约束机制保证数据的完整性.</p>

<p>B+树的结构保证一个页中至少存放两条数据</p>

<p>InnoDBPlugin引入的新的文件格式:Barracuda,这个文件格式下的行记录有Compressed和Dynamic两种</p>

<p>从Mysql4.1之后,char(N)中的N指字符长度,而不是之前版本的字节长度.</p>

<hr />

<h1 id="锁">锁</h1>

<h2 id="一致性的非锁定行读">一致性的非锁定行读</h2>

<p>在ReadCommited和RepeatableRead下,InnoDB存储引擎使用非锁定的一致性读.但在ReadCommitted事务隔离级别下,对于快照数据,非一致性读总是读取被锁定行的最新一份快照数据.在Repeatable事务隔离级别下和RepeatableRead事务隔离级别下,对于快照数据,非一致性读总是读取<strong>事务开始时的行数据版本</strong>.  <br />
InnoDB存储引擎中,通过NextKeyLock算法来避免不可重复读的问题,在这个算法下,对于索引的扫描,不仅仅锁住扫描到的索引,而且还锁住这些索引覆盖的范围,避免了另外的事务在这个范围内插入数据导致不可重复读的问题.因此InnoDB存储引擎默认的事务隔离级别是ReadRepeatable</p>

<h2 id="锁的类型">锁的类型</h2>

<p>InnoDB存储引擎实现了两种标准的行级锁:</p>

<ul>
  <li>共享锁（S Lock）：允许事务读取一行数据</li>
  <li>排它锁（X Lock）：运行事务删除或更新一行数据</li>
</ul>

<p>共享锁和排它锁都是mysql实现的悲观锁。</p>

<p>说明：</p>

<p>悲观锁和乐观锁是两个通用的概念，乐观锁是假定更新互相操作没有影响，在更新提交前检查要更新的数据是否和预期的一致，乐观锁一般使用版本号进行并发控制；悲观锁则是操作前加锁。</p>

<p>InnoDB存储引擎支持多粒度锁定，允许行级锁和表级别的锁同时存在。为了实现多粒度锁定，InnoDB存储引擎提供了意向锁，用来在一个事务中展示下一行将被请求的锁类型，意向锁是表级别的锁。</p>

<ul>
  <li>意向共享锁（IS Lock）：事务想要获得一个表中某几行的共享锁</li>
  <li>意向排它锁（IX Lock）：事务想要获得一个表中某几行的排它锁</li>
</ul>

<hr />
<p>对读取操作进行加锁：</p>

<p>select for update:对读取的行数据加一个X锁</p>

<p>select lock in share mode:对读取的行记录加一个s锁</p>

<p>需要注意的是行锁是基于索引的，如果要查询的数据未建立索引，将会对整个表加锁。</p>

<hr />

<p>InnoDB存储引擎中的三种行锁算法：</p>

<p>RecordLock:单个索引行记录的锁,锁索引记录本身,如果没有设置任何索引,InnoDB会使用隐式的主键进行锁定</p>

<p>GapLock:锁定一个范围,但不包括记录本身</p>

<p>NextKeyLock:GapLock+RecordLock,锁定一个范围,包括锁定记录本身</p>

<p>对于单个值的索引查询,加RecordLock
InnoDB对于行的查询,在RepeatableRead模式下,默认采用NextKeyLock的行记录锁定算法</p>

<hr />
<p>默认情况下,InnoDB存储引擎不会回滚超时引发的错误异常</p>

<p>InnoDB存储引擎不会回滚大部分的错误异常,但是死锁除外,发生死锁后,InnoDB存储引擎会马上回滚一个事务.(也就是说发生死锁的时候,会自动回滚一个事务,那么另一个事务会得到锁资源,继续做后续操作)</p>

<p>锁升级:会提高数据库性能,但同时并发性能降低.InnoDB存储引擎不存在锁升级的问题,因为InnoDB的锁是没有开销的.</p>

<p>查看锁的相关命令:</p>

<p>查看当前会话的事务隔离级别:<code class="highlighter-rouge">select @@tx_isolation</code>
查看全局事务隔离级别:<code class="highlighter-rouge">select @@global.tx_isolation</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>begin
commit;
show engine innodb status
</code></pre></div></div>
<p>查看当前事务中锁的情况:  <br />
<code class="highlighter-rouge">select * from information_schema.INNODB_TRX</code>  <br />
<code class="highlighter-rouge">select * from information_schema.INNODB_LOCKS</code>  <br />
<code class="highlighter-rouge">select * from information_schema.INNODB_LOCK_WAITS</code>  <br />
设置事务隔离级别:<code class="highlighter-rouge">set (global|session) transaction isolation level</code></p>

<ul>
  <li>快照读:读取的时候不会加锁,读取事务开始前的数据
事务一:
mysql&gt; begin;</li>
</ul>

<p>Query OK, 0 rows affected (0.01 sec)</p>

<p>mysql&gt; select * from users;</p>

<p>+—-+————+———-+———+———————+———————+
| id | username   | password | enabled | create_time         | update_time         |
+—-+————+———-+———+———————+———————+
|  1 | userupdate | user     |       1 | 2018-03-12 15:55:21 | 2018-03-13 19:13:44 |
|  2 | admin      | admin    |       1 | 2018-03-12 15:55:21 | 2018-03-12 15:55:21 |
+—-+————+———-+———+———————+———————+</p>

<p>2 rows in set (0.00 sec)</p>

<p>mysql&gt; update users set username =’user’ where id=1;</p>

<p>Query OK, 1 row affected (0.00 sec)</p>

<p>Rows matched: 1  Changed: 1  Warnings: 0</p>

<p>mysql&gt; select * from users;</p>

<p>+—-+———-+———-+———+———————+———————+
| id | username | password | enabled | create_time         | update_time         |
+—-+———-+———-+———+———————+———————+
|  1 | user     | user     |       1 | 2018-03-12 15:55:21 | 2018-03-13 19:16:10 |
|  2 | admin    | admin    |       1 | 2018-03-12 15:55:21 | 2018-03-12 15:55:21 |
+—-+———-+———-+———+———————+———————+</p>

<p>2 rows in set (0.00 sec)</p>

<p>mysql&gt; commit ;
Query OK, 0 rows affected (0.01 sec)</p>

<p>事务二:
mysql&gt; select * from users;</p>

<p>+—-+————+———-+———+———————+———————+
| id | username   | password | enabled | create_time         | update_time         |
+—-+————+———-+———+———————+———————+
|  1 | userupdate | user     |       1 | 2018-03-12 15:55:21 | 2018-03-13 19:13:44 |
|  2 | admin      | admin    |       1 | 2018-03-12 15:55:21 | 2018-03-12 15:55:21 |
+—-+————+———-+———+———————+———————+</p>

<p>2 rows in set (0.00 sec)</p>

<p>mysql&gt; select * from users;</p>

<p>+—-+———-+———-+———+———————+———————+
| id | username | password | enabled | create_time         | update_time         |
+—-+———-+———-+———+———————+———————+
|  1 | user     | user     |       1 | 2018-03-12 15:55:21 | 2018-03-13 19:16:10 |
|  2 | admin    | admin    |       1 | 2018-03-12 15:55:21 | 2018-03-12 15:55:21 |
+—-+———-+———-+———+———————+———————+</p>

<p>2 rows in set (0.00 sec)</p>

<p>事务二的两次查询操作分别位于commit前后.</p>

<h1 id="事务">事务</h1>

<p>确保数据库提交工作时,要么所有修改已经保存了,要么所有修改都不保存.
InnoDB存储引擎的事务符合ACID特性:atomic,consistency,isolation,durability.
隔离性由锁来保证;原子性,一致性,持久性由redo和undo来完成.</p>

<h1 id="日志">日志</h1>

<p>InnoDB的日志分为两种：逻辑日志和物理日志，物理日志的恢复速度要快于逻辑日志</p>

<p>undo log和bin log属于逻辑日志，记录操作相关的信息</p>

<p>redo log记录对每个页的修改</p>

                </article>
                </div>
            </div>
        </div>
    </div>
</div>


<footer class="footer" role="contentinfo">
	<div class="container">
		<div class="footer-col-wrapper">
			<div class="footer-col footer-col-2">
				<ul class="social-media-list">
					
					<li>
						<a href="https://github.com/swa19"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">swa19</span></a>

					</li>
					
				</ul>
			</div>
			<div class="footer-col footer-col-3">
				<p>我不是个伟大的程序员，我只是个有着一些优秀习惯的好程序员--by Kent Beck</p>
			</div>
		</div>
	</div>
</footer>


</body>
</html>