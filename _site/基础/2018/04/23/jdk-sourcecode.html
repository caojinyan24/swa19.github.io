<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Java源码学习 - </title>
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="canonical" href="/%E5%9F%BA%E7%A1%80/2018/04/23/jdk-sourcecode.html">
	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
	<meta name="keywords" content="Java源码学习, , ">
	<meta name="description" content="">
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/html5shiv.js"></script>
	<script src="/js/holder.min.js"></script>
	<script src="/js/respond.js"></script>
	<script src="/js/application.js"></script>
	<script src="/js/lessismore.js"></script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

<body class="index">

<header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">主页</a>
        </li>
        <li>
          <a href="/categories/">类别</a>
        </li>
        <li>
          <a href="/tags">标签</a>
        </li>
      </ul>

    </nav>
  </div>

</header>
<div class="docs-header" id="content">
  <div class="container">
  	
		    <h1></h1>
      <p>不积跬步，无以至千里</p>
      
  </div>
</div>
<!---->
<!--<div class="banner">
    <div class="container">
        
        <a href="/categories/#基础-ref">基础</a>
        /
        <a href="/tags/#java-ref">java</a>
        
    </div>
</div>
-->
<!---->

<div class="container docs-container">
    <div class="row">
        <div class="col-md-3">
        <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
    <h1>目录</h1>
    <ul class="nav sidenav">
        
        
        
        
        
        
        <li><a href="#year_2019">2019</a>
            <ul class="nav">
                <li><a href="#month_2019_02">02</a></li>
                
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2018">2018</a>
        <ul class="nav">
            <li><a href="#month_2018_11">11</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_10">10</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_07">07</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_06">06</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_05">05</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_04">04</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_03">03</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_02">02</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_01">01</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2017">2017</a>
        <ul class="nav">
            <li><a href="#month_2017_12">12</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_11">11</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
            </ul>
        </li>
        
            
        </ul>
</div>



        </div>
        </div>
        <div class="col-md-9" role="main">
            <div class="panel docs-content">
            <div class="wrapper">
                <header class="post-header">
                    <h1 class="post-title">Java源码学习</h1>
                    <div class="meta"><span class="postdate">2018-04-23 21:04:08</span></div>
                    <br/>
                </header>
                <article class="post-content">
                    <ul id="markdown-toc">
  <li><a href="#copyonwritearraylist" id="markdown-toc-copyonwritearraylist">CopyOnWriteArrayList</a></li>
  <li><a href="#concurrenthashmap" id="markdown-toc-concurrenthashmap">ConcurrentHashMap</a></li>
  <li><a href="#hashtable" id="markdown-toc-hashtable">hashTable</a></li>
  <li><a href="#treemaptreeset" id="markdown-toc-treemaptreeset">TreeMap，TreeSet</a></li>
  <li><a href="#reentrantlock" id="markdown-toc-reentrantlock">ReentrantLock</a></li>
  <li><a href="#threadpoolexecutor" id="markdown-toc-threadpoolexecutor">ThreadPoolExecutor</a></li>
  <li><a href="#linkedblockedqueue" id="markdown-toc-linkedblockedqueue">LinkedBlockedQueue</a></li>
</ul>

<h1 id="copyonwritearraylist">CopyOnWriteArrayList</h1>

<p>jdk中对Collection操作有一个共识：就是在循环中是不能对列表做修改的。前几天写个小工具，要求对一个List做遍历，并在遍历过程中向List添加元素。翻了Collection的子类之后，发现<code class="highlighter-rouge">CopyOnWriteArrayList</code>可以解决这个问题。</p>

<p>看下其中的add方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/** The array, accessed only via getArray/setArray. */
private transient volatile Object[] array;

/**
 * Gets the array.  Non-private so as to also be accessible
 * from CopyOnWriteArraySet class.
 */
final Object[] getArray() {
    return array;
}
/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */
public boolean add(E e) {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        Object[] elements = getArray();
        int len = elements.length;
        Object[] newElements = Arrays.copyOf(elements, len + 1);
        newElements[len] = e;
        setArray(newElements);
        return true;
    } finally {
        lock.unlock();
    }
}
/**
 * Sets the array.
 */
final void setArray(Object[] a) {
    array = a;
}
</code></pre></div></div>

<p>首先，<code class="highlighter-rouge">CopyOnWriteArrayList</code>对内部数组的操作通过<code class="highlighter-rouge">getArray</code>和<code class="highlighter-rouge">setArray</code>进行。当需要向数组中添加元素时，通过<code class="highlighter-rouge">  Object[] newElements = Arrays.copyOf(elements, len + 1);</code>创建一个原数组的拷贝，在向新数组中添加元素后，将内部数组指向新数组的引用。</p>

<p>同时对<code class="highlighter-rouge">CopyOnWriteArrayList</code>对象的任何修改都需要首先获取到对象锁：<code class="highlighter-rouge">final transient ReentrantLock lock = new ReentrantLock();</code>从而保证了线程的安全性。</p>

<h1 id="concurrenthashmap">ConcurrentHashMap</h1>

<ol>
  <li>根据key做hash后，进行分段，不同段使用不同的锁控制，提高并发访问效率；另外当需要rehash的时候，只对某个分段做rehash</li>
  <li>所有需要共享的变量使用volitale关键字，乐观锁提高了并发量</li>
</ol>

<h1 id="hashtable">hashTable</h1>

<p>各个方法使用synchronized修饰来保证多线程并发访问的安全，效率较低</p>

<h1 id="treemaptreeset">TreeMap，TreeSet</h1>

<p>一个基于红黑树实现的有序的map和set，线程不安全</p>

<h1 id="reentrantlock">ReentrantLock</h1>

<p>ReentrantLock的锁的控制是通过AbstractQueuedSynchronizer类的子类（<code class="highlighter-rouge">abstract static class Sync extends AbstractQueuedSynchronizer</code>）实现的。</p>

<p>Sync类提供的方法有：</p>

<ol>
  <li>锁定：<code class="highlighter-rouge">abstract void lock()</code></li>
  <li>获取锁：<code class="highlighter-rouge">final boolean nonfairTryAcquire(int acquires) </code></li>
  <li>释放锁：<code class="highlighter-rouge">protected final boolean tryRelease(int releases) </code></li>
  <li>判断当前线程是否获得当前锁：<code class="highlighter-rouge">protected final boolean isHeldExclusively()</code>，如果当前锁由当前线程获得，则返回true</li>
  <li>新建condition：<code class="highlighter-rouge">final ConditionObject newCondition()</code></li>
  <li>查询获得当前锁的线程：<code class="highlighter-rouge">final Thread getOwner() </code>。其中的getExclusiveOwnerThread()方法来自<code class="highlighter-rouge">AbstractOwnableSynchronizer</code>，在这个类中有一个属性<code class="highlighter-rouge">private transient Thread exclusiveOwnerThread;</code>用来表示当前获取排他锁的线程。</li>
  <li>查询锁定的次数：<code class="highlighter-rouge">final int getHoldCount()</code>，0代表未被当前线程获得锁</li>
  <li>查询是否是锁定状态：<code class="highlighter-rouge">final boolean isLocked() </code>，getState为0代表未锁定</li>
  <li>反序列化：<code class="highlighter-rouge">private void readObject(java.io.ObjectInputStream s)</code></li>
</ol>

<p>通过Sync的一个实例来实现线程控制，根据Sync的实现的不同，分为公平锁和不公平锁两种，这两种锁的实现如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   static final class NonfairSync extends Sync {
       private static final long serialVersionUID = 7316153563782823691L;

       /**
        * Performs lock.  Try immediate barge, backing up to normal
        * acquire on failure.
        */
       final void lock() {
           if (compareAndSetState(0, 1))
               setExclusiveOwnerThread(Thread.currentThread());
           else
               acquire(1);
       }

       protected final boolean tryAcquire(int acquires) {
           return nonfairTryAcquire(acquires);
       }
   }
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static final class FairSync extends Sync {
    private static final long serialVersionUID = -3000897897090466540L;

    final void lock() {
        acquire(1);
    }

    /**
     * Fair version of tryAcquire.  Don't grant access unless
     * recursive call or no waiters or is first.
     */    
    protected final boolean tryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (!hasQueuedPredecessors() &amp;&amp;
                compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0)
                throw new Error("Maximum lock count exceeded");
            setState(nextc);
            return true;
        }
        return false;
    }
}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public final void acquire(int arg) {
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
</code></pre></div></div>

<p>公平锁和sychronized类似，根据获取锁的先后顺序执行</p>

<p>对不公平锁，在执行lock()函数时，首先利用cas进行锁定，如果锁定成功，直接插入，否则，正常等待锁释放。</p>

<p>在创建ReentrantLock实例时，默认是不公平锁</p>

<p>相比sychronized的特性：</p>

<ol>
  <li>在获取锁的时候，如果获取不到可直接返回；避免阻塞线程</li>
  <li>可设置优先级，中断正在执行的线程</li>
  <li>将锁的相关信息以对象的形式做封装，可以获取到当前锁的信息，如等待的线程队列，当前获取锁的线程等</li>
</ol>

<h1 id="threadpoolexecutor">ThreadPoolExecutor</h1>

<p><code class="highlighter-rouge">private final BlockingQueue&lt;Runnable&gt; workQueue;</code>：存放任务</p>

<p>execute</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    /*
     * Proceed in 3 steps:
     *
     * 1. If fewer than corePoolSize threads are running, try to
     * start a new thread with the given command as its first
     * task.  The call to addWorker atomically checks runState and
     * workerCount, and so prevents false alarms that would add
     * threads when it shouldn't, by returning false.
     *
     * 2. If a task can be successfully queued, then we still need
     * to double-check whether we should have added a thread
     * (because existing ones died since last checking) or that
     * the pool shut down since entry into this method. So we
     * recheck state and if necessary roll back the enqueuing if
     * stopped, or start a new thread if there are none.
     *
     * 3. If we cannot queue task, then we try to add a new
     * thread.  If it fails, we know we are shut down or saturated
     * and so reject the task.
     */
    int c = ctl.get();
    if (workerCountOf(c) &lt; corePoolSize) {
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    if (isRunning(c) &amp;&amp; workQueue.offer(command)) {
        int recheck = ctl.get();
        if (! isRunning(recheck) &amp;&amp; remove(command))
            reject(command);
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    else if (!addWorker(command, false))
        reject(command);
}

</code></pre></div></div>

<ol>
  <li>获取当前线程数，如果小于核心线程数，则执行addWorker操作</li>
  <li>如果当前标示线程池未销毁，并且当前任务队列存在空余位置
2.1. 再次check，如果当前线程池未运行，并且当前任务可成功移除，拒绝当前任务
2.2. 如果再次check，核心线程已满，重新起线程做addWork操作</li>
  <li>如果条件2不成立
3.1. 新建线程执行addWork操作
3.2. 如果3.1失败，拒绝当前任务</li>
</ol>

<p>addWorker首先再次核对当前的线程池状态，跟任务列表，如果可以执行，则添加任务到任务列表中，并且启动线程</p>

<p>在向任务队列中添加任务时，使用ReentraintLock做并发控制（因为这里的workers的类型是HashSet，不能保证并发的安全问题，根据HashSet文档，通过<code class="highlighter-rouge">Set s = Collections.synchronizedSet(new HashSet(...));</code>可以保证并发安全）</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private boolean addWorker(Runnable firstTask, boolean core) {
    retry:
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);

        // Check if queue empty only if necessary.
        if (rs &gt;= SHUTDOWN &amp;&amp;
            ! (rs == SHUTDOWN &amp;&amp;
               firstTask == null &amp;&amp;
               ! workQueue.isEmpty()))
            return false;

        for (;;) {
            int wc = workerCountOf(c);
            if (wc &gt;= CAPACITY ||
                wc &gt;= (core ? corePoolSize : maximumPoolSize))
                return false;
            if (compareAndIncrementWorkerCount(c))
                break retry;
            c = ctl.get();  // Re-read ctl
            if (runStateOf(c) != rs)
                continue retry;
            // else CAS failed due to workerCount change; retry inner loop
        }
    }

    boolean workerStarted = false;
    boolean workerAdded = false;
    Worker w = null;
    try {
        w = new Worker(firstTask);
        final Thread t = w.thread;
        if (t != null) {
            final ReentrantLock mainLock = this.mainLock;
            mainLock.lock();
            try {
                // Recheck while holding lock.
                // Back out on ThreadFactory failure or if
                // shut down before lock acquired.
                int rs = runStateOf(ctl.get());

                if (rs &lt; SHUTDOWN ||
                    (rs == SHUTDOWN &amp;&amp; firstTask == null)) {
                    if (t.isAlive()) // precheck that t is startable
                        throw new IllegalThreadStateException();
                    workers.add(w);
                    int s = workers.size();
                    if (s &gt; largestPoolSize)
                        largestPoolSize = s;
                    workerAdded = true;
                }
            } finally {
                mainLock.unlock();
            }
            if (workerAdded) {
                t.start();
                workerStarted = true;
            }
        }
    } finally {
        if (! workerStarted)
            addWorkerFailed(w);
    }
    return workerStarted;
}
</code></pre></div></div>

<p>每个Worker实例是一个Runnable子类</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    w.unlock(); // allow interrupts
    boolean completedAbruptly = true;
    try {
        while (task != null || (task = getTask()) != null) {
            w.lock();
            // If pool is stopping, ensure thread is interrupted;
            // if not, ensure thread is not interrupted.  This
            // requires a recheck in second case to deal with
            // shutdownNow race while clearing interrupt
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp;
                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt();
            try {
                beforeExecute(wt, task);
                Throwable thrown = null;
                try {
                    task.run();
                } catch (RuntimeException x) {
                    thrown = x; throw x;
                } catch (Error x) {
                    thrown = x; throw x;
                } catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } finally {
                    afterExecute(task, thrown);
                }
            } finally {
                task = null;
                w.completedTasks++;
                w.unlock();
            }
        }
        completedAbruptly = false;
    } finally {
        processWorkerExit(w, completedAbruptly);
    }
}
</code></pre></div></div>

<p><code class="highlighter-rouge">  while (task != null || (task = getTask()) != null)</code>在while循环中，从当前的<code class="highlighter-rouge">BlockingQueue&lt;Runnable&gt; workQueue</code>和
<code class="highlighter-rouge">private final HashSet&lt;Worker&gt; workers</code>取出task，这两个的区别是，workers是线程池中加入的所有的Worker，而workQueue则是所有即将运行的任务队列，当添加任务时，workers添加数据，添加失败或者任务退出（执行完毕）的时候移走，而workQueue则是在执行addWorker前添加，表示要执行的线程队列。</p>

<h1 id="linkedblockedqueue">LinkedBlockedQueue</h1>

<p>通过ReentrantLock的Condition实现添加和删除的等待。</p>

                </article>
                </div>
            </div>
        </div>
    </div>
</div>


<footer class="footer" role="contentinfo">
	<div class="container">
		<div class="footer-col-wrapper">
			<div class="footer-col footer-col-2">
				<ul class="social-media-list">
					
					<li>
						<a href="https://github.com/swa19"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">swa19</span></a>

					</li>
					
				</ul>
			</div>
			<div class="footer-col footer-col-3">
				<p>我不是个伟大的程序员，我只是个有着一些优秀习惯的好程序员--by Kent Beck</p>
			</div>
		</div>
	</div>
</footer>


</body>
</html>