<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>jvm内存相关及问题排查 - </title>
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="canonical" href="/%E5%9F%BA%E7%A1%80/2018/04/12/java-memory.html">
	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
	<meta name="keywords" content="jvm内存相关及问题排查, , ">
	<meta name="description" content="">
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/html5shiv.js"></script>
	<script src="/js/holder.min.js"></script>
	<script src="/js/respond.js"></script>
	<script src="/js/application.js"></script>
	<script src="/js/lessismore.js"></script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

<body class="index">

<header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">主页</a>
        </li>
        <li>
          <a href="/categories/">类别</a>
        </li>
        <li>
          <a href="/tags">标签</a>
        </li>
      </ul>

    </nav>
  </div>

</header>
<div class="docs-header" id="content">
  <div class="container">
  	
		    <h1></h1>
      <p>不积跬步，无以至千里</p>
      
  </div>
</div>
<!---->
<!--<div class="banner">
    <div class="container">
        
        <a href="/categories/#基础-ref">基础</a>
        /
        <a href="/tags/#java-ref">java</a>
        
    </div>
</div>
-->
<!---->

<div class="container docs-container">
    <div class="row">
        <div class="col-md-3">
        <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
    <h1>目录</h1>
    <ul class="nav sidenav">
        
        
        
        
        
        
        <li><a href="#year_2019">2019</a>
            <ul class="nav">
                <li><a href="#month_2019_02">02</a></li>
                
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2018">2018</a>
        <ul class="nav">
            <li><a href="#month_2018_11">11</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_10">10</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_07">07</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_06">06</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_05">05</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_04">04</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_03">03</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_02">02</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_01">01</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2017">2017</a>
        <ul class="nav">
            <li><a href="#month_2017_12">12</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_11">11</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
            </ul>
        </li>
        
            
        </ul>
</div>



        </div>
        </div>
        <div class="col-md-9" role="main">
            <div class="panel docs-content">
            <div class="wrapper">
                <header class="post-header">
                    <h1 class="post-title">jvm内存相关及问题排查</h1>
                    <div class="meta"><span class="postdate">2018-04-12 22:49:48</span></div>
                    <br/>
                </header>
                <article class="post-content">
                    <ul id="markdown-toc">
  <li><a href="#问题排查" id="markdown-toc-问题排查">问题排查</a></li>
  <li><a href="#jvm内存配置" id="markdown-toc-jvm内存配置">jvm内存配置</a></li>
  <li><a href="#jvm内存溢出与内存泄露" id="markdown-toc-jvm内存溢出与内存泄露">jvm内存溢出与内存泄露</a></li>
  <li><a href="#jvm内存溢出排查" id="markdown-toc-jvm内存溢出排查">jvm内存溢出排查</a>    <ul>
      <li><a href="#top查看当前进程的占用情况" id="markdown-toc-top查看当前进程的占用情况">top：查看当前进程的占用情况</a></li>
      <li><a href="#jmap命令" id="markdown-toc-jmap命令">jmap命令</a></li>
      <li><a href="#jstat" id="markdown-toc-jstat">jstat</a></li>
      <li><a href="#jdk提供的可视化的两个工具" id="markdown-toc-jdk提供的可视化的两个工具">jdk提供的可视化的两个工具</a></li>
    </ul>
  </li>
  <li><a href="#jvm内存结构" id="markdown-toc-jvm内存结构">jvm内存结构</a>    <ul>
      <li><a href="#延伸学习" id="markdown-toc-延伸学习">延伸学习</a></li>
    </ul>
  </li>
</ul>

<h1 id="问题排查">问题排查</h1>

<p>前几天一个项目代码报Heap OutOfMemory错误，排查了下代码没有发现问题，没办法只能采用最笨的删代码方式排查，经过艰难的排查，最后定位到了出问题的地方是一个一个第三方提供的工具类，用来做加解密。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static byte[] encrypt(RSAPublicKey publicKey, byte[] plainTextData) throws Exception {
    if (publicKey == null) {
        throw new Exception("加密公钥为空, 请设置");
    } else {
        try {
            Cipher cipher = Cipher.getInstance("RSA", new BouncyCastlededeProvider());
            cipher.init(1, publicKey);
            byte[] output = cipher.doFinal(plainTextData);
            return output;
        } catch (NoSuchAlgorithmException var4) {
            throw new Exception("无此加密算法");
        } catch (NoSuchPaddingException var5) {
            return null;
        } catch (InvalidKeyException var6) {
            throw new Exception("加密公钥非法,请检查");
        } catch (IllegalBlockSizeException var7) {
            throw new Exception("明文长度非法");
        } catch (BadPaddingException var8) {
            throw new Exception("明文数据已损坏");
        } catch (Exception var9) {
            var9.printStackTrace();
            return null;
        }
    }
}
</code></pre></div></div>

<p>其中的<code class="highlighter-rouge">BouncyCastlededeProvider</code>来自</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;dependency&gt;
&lt;group&gt;org.bouncycastle&lt;/group&gt;
&lt;artifact&gt;bcprov-jdk15on&lt;/artifact&gt;
&lt;version&gt;1.56&lt;version&gt;
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public BouncyCastleProvider() {
        super("BC", 1.56D, info);
        AccessController.doPrivileged(new PrivilegedAction() {
            public Object run() {
                BouncyCastleProvider.this.setup();
                return null;
            }
        });
    }  
</code></pre></div></div>

<p>乍一看代码似乎没问题，毕竟一般印象中，局部的临时变量会自动被回收掉的。此时发现网络上也存在过相同加解密的内存泄露问题，但其中提出的解释细究起来的话并不经得起推敲。  <br />
于是再次排查代码，知道是哪个对象没有被回收之后，排查起来就有目的得多了。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//javax.crypto.JceSecurity类
private static final Map&lt;Provider, Object&gt; verificationResults = new IdentityHashMap();

static synchronized Exception getVerificationResult(Provider var0) {
        Object var1 = verificationResults.get(var0);
        if (var1 == PROVIDER_VERIFIED) {
            return null;
        } else if (var1 != null) {
            return (Exception)var1;
        } else if (verifyingProviders.get(var0) != null) {
            return new NoSuchProviderException("Recursion during verification");
        } else {
            Exception var3;
            try {
                verifyingProviders.put(var0, Boolean.FALSE);
                URL var2 = getCodeBase(var0.getClass());
                verifyProviderJar(var2);
                verificationResults.put(var0, PROVIDER_VERIFIED);
                var3 = null;
                return var3;
            } catch (Exception var7) {
                verificationResults.put(var0, var7);
                var3 = var7;
            } finally {
                verifyingProviders.remove(var0);
            }
            return var3;
        }
    }
</code></pre></div></div>

<p>出现内存泄露的原因在于Cipher类的273行getInstance方法中<code class="highlighter-rouge">Exception var9 = JceSecurity.getVerificationResult(var1);</code>会在<code class="highlighter-rouge">verificationResults</code>中添加一个Provider实例的引用。那么由于在方法调用时，每次都是新建一个<code class="highlighter-rouge">BouncyCastleProvider</code>对象，而这个对象由于被一个静态的Map引用，这个Map不会被回收，相应的它持有的对象也无法被内存回收，也由此导致内存占用不断增加，最终导致OOM。</p>

<p>最后总结下这次排查过程中涉及到的小知识点。</p>

<hr />

<h1 id="jvm内存配置">jvm内存配置</h1>

<p><code class="highlighter-rouge">-Xmx</code>：JAVA HEAP的最大值、默认为物理内存的1/4  <br />
<code class="highlighter-rouge">-Xms</code>：JAVA HEAP的初始值，server端最好Xms与Xmx一样  <br />
<code class="highlighter-rouge">-Xmn</code>：JAVA HEAP young区的大小  <br />
<code class="highlighter-rouge">-XX:MetaspaceSize</code>：元空间的初始值  <br />
<code class="highlighter-rouge">-XX:MaxMetaspaceSize</code>：元空间的最大值</p>

<p>设置jvm参数</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Xms64m -Xmx64m -XX:NewRatio=1 -XX:MaxMetaspaceSize=128m -XX:MetaspaceSize=128m -Xverify:none  -XX:MaxTenuringThreshold=7 -XX:GCTimeRatio=19 -XX:+DisableExplicitGC -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:-CMSParallelRemarkEnabled -XX:CMSInitiatingOccupancyFraction=70 -Ddubbo.shutdown.hook=true   -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintHeapAtGC -XX:+PrintGCApplicationStoppedTime
</code></pre></div></div>

<h1 id="jvm内存溢出与内存泄露">jvm内存溢出与内存泄露</h1>

<p>内存泄露：使用资源后未及时释放，导致可用的内存空间越来越少，最终会导致OutOfMemory异常
内存溢出：需要申请的资源超出了内存的大小；如果排查不存在内存泄露的情况的话，增加jvm的内存大小就可以解决这个问题。</p>

<h1 id="jvm内存溢出排查">jvm内存溢出排查</h1>

<h2 id="top查看当前进程的占用情况">top：查看当前进程的占用情况</h2>

<p>通过Top命令查看到当前占用内存最大的进程ID</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>top - 19:02:54 up  8:39,  1 user,  load average: 1.07, 1.40, 1.52
Tasks: 265 total,   1 running, 263 sleeping,   0 stopped,   1 zombie
%Cpu(s): 17.6 us, 11.8 sy,  0.0 ni, 69.5 id,  1.0 wa,  0.0 hi,  0.1 si,  0.0 st
KiB Mem :  8055528 total,   200152 free,  5935260 used,  1920116 buff/cache
KiB Swap:  8268796 total,  6317248 free,  1951548 used.  1044616 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                             
 2540 jinyan    20   0 3451680 636596 596264 S  33.1  7.9  97:19.71 VirtualBox                                                                                                          
 3375 jinyan    20   0 2114904 363400 172636 S  30.8  4.5   4:22.18 Web Content                                                                                                         
 1275 root      20   0  812292 176828 132744 S  11.9  2.2  48:02.33 Xorg                                                                                                                
 2168 jinyan    20   0 1577936  69508  31128 S  10.9  0.9  40:07.43 compiz                                                                                                              
29065 jinyan    20   0 1380620 181444  38224 S   8.9  2.3  61:25.38 chrome                                                                                                              
 8164 jinyan    20   0 5177944 1.864g  17408 S   7.9 24.3 144:10.11 java                                                                                                                
15841 jinyan    20   0  604880  19592  11132 S   5.0  0.2   0:19.73 gnome-terminal-                                                                                                     
 3291 jinyan    20   0 2465916 365664 196344 S   4.0  4.5   2:29.34 firefox                                                                                                             
 1227 root      20   0  259140   2092   1912 S   1.7  0.0   7:55.14 ECAgent                                                                                                             
 8628 jinyan    20   0 5680828 418008   6016 S   1.3  5.2   2:30.30 java                                                                                                                
 2496 jinyan    20   0  830468   9772   7188 S   1.0  0.1   4:40.63 VBoxSVC                                                                                                             
 2491 jinyan    20   0  168348   2252   2016 S   0.7  0.0   2:13.66 VBoxXPCOMIPCD                                                                                                       
 3332 jinyan    20   0 1833268  96644  32300 S   0.7  1.2   5:43.61 atom                                                                                                                
 3465 jinyan    20   0 1887036 188088 118676 S   0.7  2.3   1:17.25 Web Content                                                                                                         
 4461 jinyan    20   0 1418752 152312  42148 S   0.7  1.9   2:24.72 atom                                                                                                                
 9135 jinyan    20   0   43676   3828   3076 R   0.7  0.0   0:00.11 top   
</code></pre></div></div>

<p>分析：  <br />
上边几行比较容易理解，看下下边的几个变量
PR：优先级  <br />
VIRT：进程使用的虚拟内存总量  <br />
RES：进程使用的、未被换出的物理内存大小  <br />
SHR：共享内存大小  <br />
S：进程状态（D不可中断的睡眠状态；R运行；S睡眠；T跟踪/停止；Z：僵尸进程）  <br />
%CPU：上次更新到现在的CPU时间占用百分比  <br />
%MEM：进程使用的物理内存百分比  <br />
TIME+：进程使用的CPU时间总计  <br />
COMMAND：命令名/命令行</p>

<p><a href="http://www.jb51.net/LINUXjishu/34604.html">TOP命令参考地址</a></p>

<h2 id="jmap命令">jmap命令</h2>

<p>查看指定进程的jvm物理内存的占用情况   <br />
<code class="highlighter-rouge">jmap -histo:live ${pid} </code>：  查看当前内存中的类实例及个数  <br />
<code class="highlighter-rouge">jps</code>：查看本地的java进程</p>

<h2 id="jstat">jstat</h2>

<p><code class="highlighter-rouge">jstat -gcutil pid 1000</code> 每1000ms打印一次各个内存分区的占用情况</p>

<p><a href="http://www.51testing.com/html/92/77492-203728.html">jstat详细使用</a></p>

<h2 id="jdk提供的可视化的两个工具">jdk提供的可视化的两个工具</h2>

<p><code class="highlighter-rouge">jconsole</code>，<code class="highlighter-rouge">jvisualvm</code>：这两个工具就我的使用来看，功能差不多，我习惯用jvisualvm，可以查看各项jvm参数，在排查内存泄露问题的时候，可以动态查看各种类的实例个数和内存占用情况。</p>

<h1 id="jvm内存结构">jvm内存结构</h1>

<p><img src="/_pic/201804/jvm-memory.png" alt="" /></p>

<h2 id="延伸学习">延伸学习</h2>

<p><a href="http://ifeve.com/gc-oriented-java-programming/">面向GC的Java编程</a>  <br />
<a href="http://blog.hesey.net/2011/04/introduction-to-java-virtual-machine.html">浅析Java虚拟机结构与机制</a>  <br />
<a href="https://blog.csdn.net/zjf280441589/article/details/53437703">JVM初探 -JVM内存模型</a></p>

                </article>
                </div>
            </div>
        </div>
    </div>
</div>


<footer class="footer" role="contentinfo">
	<div class="container">
		<div class="footer-col-wrapper">
			<div class="footer-col footer-col-2">
				<ul class="social-media-list">
					
					<li>
						<a href="https://github.com/swa19"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">swa19</span></a>

					</li>
					
				</ul>
			</div>
			<div class="footer-col footer-col-3">
				<p>我不是个伟大的程序员，我只是个有着一些优秀习惯的好程序员--by Kent Beck</p>
			</div>
		</div>
	</div>
</footer>


</body>
</html>