<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>JMX - </title>
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="canonical" href="/%E5%9F%BA%E7%A1%80/2018/03/31/jmx.html">
	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
	<meta name="keywords" content="JMX, , ">
	<meta name="description" content="">
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/html5shiv.js"></script>
	<script src="/js/holder.min.js"></script>
	<script src="/js/respond.js"></script>
	<script src="/js/application.js"></script>
	<script src="/js/lessismore.js"></script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

<body class="index">

<header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">主页</a>
        </li>
        <li>
          <a href="/categories/">类别</a>
        </li>
        <li>
          <a href="/tags">标签</a>
        </li>
      </ul>

    </nav>
  </div>

</header>
<div class="docs-header" id="content">
  <div class="container">
  	
		    <h1></h1>
      <p>不积跬步，无以至千里</p>
      
  </div>
</div>
<!---->
<!--<div class="banner">
    <div class="container">
        
        <a href="/categories/#基础-ref">基础</a>
        /
        <a href="/tags/#java-ref">java</a>
        
    </div>
</div>
-->
<!---->

<div class="container docs-container">
    <div class="row">
        <div class="col-md-3">
        <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
    <h1>目录</h1>
    <ul class="nav sidenav">
        
        
        
        
        
        
        <li><a href="#year_2019">2019</a>
            <ul class="nav">
                <li><a href="#month_2019_02">02</a></li>
                
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2018">2018</a>
        <ul class="nav">
            <li><a href="#month_2018_11">11</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_10">10</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_07">07</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_06">06</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_05">05</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_04">04</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_03">03</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_02">02</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2018_01">01</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
    </ul>
    </li>
    <li><a href="#year_2017">2017</a>
        <ul class="nav">
            <li><a href="#month_2017_12">12</a></li>
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_11">11</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_09">09</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
        
            
            <li><a href="#month_2017_08">08</a></li>
            
            
            
            
        
        
        
        
        
                
        
            
            
            
            
        
        
        
        
        
                
            </ul>
        </li>
        
            
        </ul>
</div>



        </div>
        </div>
        <div class="col-md-9" role="main">
            <div class="panel docs-content">
            <div class="wrapper">
                <header class="post-header">
                    <h1 class="post-title">JMX</h1>
                    <div class="meta"><span class="postdate">2018-03-31 22:49:48</span></div>
                    <br/>
                </header>
                <article class="post-content">
                    <ul id="markdown-toc">
  <li><a href="#jmx能做什么" id="markdown-toc-jmx能做什么">JMX能做什么</a></li>
  <li><a href="#jmx是什么" id="markdown-toc-jmx是什么">JMX是什么</a>    <ul>
      <li><a href="#基础层" id="markdown-toc-基础层">基础层</a></li>
      <li><a href="#适配层" id="markdown-toc-适配层">适配层</a></li>
      <li><a href="#接入层" id="markdown-toc-接入层">接入层</a></li>
    </ul>
  </li>
  <li><a href="#为什么要用" id="markdown-toc-为什么要用">为什么要用</a></li>
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
</ul>

<p>看tomcat源码的时候,看到一个MBean的概念,从而了解到了JMX.
JMX,全称Java Management Extensions,是管理java的一种扩展.它提供了一个观察、改变正在运行的java程序变量的一个途径.</p>

<h1 id="jmx能做什么">JMX能做什么</h1>

<p>首先看一个示例程序，从网上找到的示例:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public interface UserMBean {
    String getUsername();
    void setUsername(String username);
    String getPassword();
    void setPassword(String password);
    int add(int x, int y);
}
public class User implements UserMBean {
    private String username;
    private String password;
    public String getUsername() {
        return username;
    }
    public void setUsername(String username) {
        this.username = username;
    }
    @Override
    public String getPassword() {
        return password;
    }
    @Override
    public void setPassword(String password) {
        this.password = password;
    }
    public int add(int x, int y) {
        return x + y;
    }
}
import javax.management.MBeanServer;
import javax.management.ObjectName;
import java.lang.management.ManagementFactory;
public class MBeanTest {
    public static void main(String[] args) {
        try {
            MBeanServer beanServer = ManagementFactory.getPlatformMBeanServer();
            ObjectName objectName = new ObjectName("jmxdemo:type=User");
            User user = new User();
            beanServer.registerMBean(user, objectName);
            String oldusername = null;
            String oldpassword = null;
            while (true) {
                if (oldusername != user.getUsername() || oldpassword != user.getPassword()) {
                    System.out.println(user.getUsername() + ',' + user.getPassword());
                    oldusername = user.getUsername();
                    oldpassword = user.getPassword();
                }
                Thread.sleep(1000);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre></div></div>

<p>运行MBeanTest的main方法后,在控制台通过<code class="highlighter-rouge">jconsole</code>命令启动java控制台监控
<img src="/_pic/201803/jconsole.png" alt="" /></p>

<p>选中我们的测试类:MBeanTest连接,在MBeans标签下,找到我们的jmxdemo,可以看到User下的两个属性和一个方法.此时修改username
<img src="/_pic/201803/jmx-modify.png" alt="" />
在main方法中,当User对象的属性发生变化的时候会在控制台打印新的属性值,修改后在控制台可以看到我们经过jconsole修改的属性已经生效.</p>

<h1 id="jmx是什么">JMX是什么</h1>

<p>看下Apache的官方说明:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The JMX technology provides the tools for building distributed, Web-based, modular and 
dynamic solutions for managing and monitoring devices, applications, and service-driven networks. By design, 
this standard is suitable for adapting legacy systems, implementing new management and monitoring solutions, 
and plugging into those of the future. 
</code></pre></div></div>
<blockquote>
  <p>JMX为建立分布式,基于web技术,模块化动态管理和监控设备,应用,基于服务的网络提供了一个工具.根据设计,这个标准可以适配旧系统,也可以为新的系统提供一个增强的管理和监控功能.</p>
</blockquote>

<p>JMX的架构分为三层
<img src="/_pic/201803/jmx-stru.jpg" alt="" /></p>

<h2 id="基础层">基础层</h2>
<p>最底层的是MBean,也就是我们需要管理的类.MBean有三种:StandardMBean,DynamicMBean,OpenBean</p>

<ol>
  <li>StandardMBean
大多数的MBean通过类名以MBean结尾来指定当前类为StandardMBean,如上边的UserMBean,然后通过代理来和MBean做交互:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public interface CacheControlMBean {
    //如果是需要做远程调用的,最好是在方法中抛出IOException,以免在做代理的时候,这个异常被UndeclaredThrowableException包裹
    int getSize() throws IOException;
    void setSize(int size) throws IOException;
    int getUsage() throws IOException;
    int dropOldest(int n) throws IOException;
}
public void main() {
    MBeanServer mbs = ...;
    Integer sizeI = (Integer) mbs.getAttribute(objectName, "Size");
    int size = sizeI.intValue();
    if (size &gt; desiredSize) {
        mbs.invoke(objectName,
                "dropOldest",
                new Integer[]{new Integer(size - desiredSize)},
                new String[]{"int"});
    }
    MBeanServer mbs = ...;
    CacheControlMBean cacheControl = (CacheControlMBean)
            MBeanServerInvocationHandler.newProxyInstance(mbs,
                    objectName,
                    CacheControlMBean.class,
                    false);
    int size = cacheControl.getSize();
    if (size &gt; desiredSize)
        cacheControl.dropOldest(size - desiredSize);
}
</code></pre></div></div>

<ol>
  <li>Dynamic MBeans</li>
</ol>

<p>Dynamic MBeans用于在编译阶段未生成的接口或类,dynamic MBean必须实现javax.management.DynamicMBean接口，所有的属性，方法都在运行时定义</p>

<ol>
  <li>OpenBean
MBean中的属性只能使用基本的java类型,在jdk1.6之前,如果需要使用CompositeData来表示这个属性是OpenType类型,具体可以参考JMX的官方文档<a href="http://www.oracle.com/technetwork/java/javase/tech/best-practices-jsp-136021.html#mozTocId931827">CompositeData</a>.在JDK1.6中,引入了MXBean的概念,它会自动把CompositeType转换为指定的类型,使得MBean的属性可以是任何java类型.
要标示一个类为MXBean有以下方式:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//public并且类名以MXBean结尾
public interface WhatsitMXBean {}
//添加@MXBean注解
@MXBean
public interface Whatsit1Interface {}
@MXBean(true)
public interface Whatsit2Interface {}
</code></pre></div></div>
<p>尽管这样,在声明这个复杂类的时候,还是需要标示这个类是CompositeType,以便能够正常做转换.java文档中提供了4种方式:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Static {@code from} method:
public class NamedNumber {
    public int getNumber() {return number;}
    public String getName() {return name;}
    private NamedNumber(int number, String name) {
        this.number = number;
        this.name = name;
    }
    public static NamedNumber from(CompositeData cd) {
        return new NamedNumber((Integer) cd.get("number"),
                               (String) cd.get("name"));
    }
    private final int number;
    private final String name;
}

Public constructor with @ConstructorProperties annotation:
public class NamedNumber {
    public int getNumber() {return number;}
    public String getName() {return name;}
    @ConstructorProperties({"number", "name"})
    public NamedNumber(int number, String name) {
        this.number = number;
        this.name = name;
    }
    private final int number;
    private final String name;
}

Setter for every getter:
public class NamedNumber {
    public int getNumber() {return number;}
    public void setNumber(int number) {this.number = number;}
    public String getName() {return name;}
    public void setName(String name) {this.name = name;}
    public NamedNumber() {}
    private int number;
    private String name;
}

Interface with only getters:
public interface NamedNumber {
    public int getNumber();
    public String getName();
}

</code></pre></div></div>

<h2 id="适配层">适配层</h2>
<p>MBeanServer，主要是提供对资源的注册和管理,和远程做通信</p>

<h2 id="接入层">接入层</h2>
<p>提供远程访问的入口,接口是javax.management.remote.JMXConnector
Java提供了几种方式来做接入层</p>

<ol>
  <li>直接在服务器端启动jconsole查看,也就是示例代码中展示的.</li>
  <li>通过页面来访问
修改MBeanTest如下:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MBeanTest {
    public static void main(String[] args) {
        try {
// MBeanServer beanServer = ManagementFactory.getPlatformMBeanServer();
// ObjectName objectName = new ObjectName("jmxdemo:type=User");
// User user = new User();
// beanServer.registerMBean(user, objectName);
            MBeanServer server = ManagementFactory.getPlatformMBeanServer();
            ObjectName objectName = new ObjectName("jmxdemo:type=User");
            User user = new User();
            server.registerMBean(user, objectName);
            ObjectName adapterName = new ObjectName("UserAgent:name=htmladapter,port=8082");
            HtmlAdaptorServer adapter = new HtmlAdaptorServer();
            server.registerMBean(adapter, adapterName);
            adapter.start();
            String oldusername = null;
            String oldpassword = null;
            while (true) {
                if (oldusername != user.getUsername() || oldpassword != user.getPassword()) {
                    System.out.println(user.getUsername() + ',' + user.getPassword());
                    oldusername = user.getUsername();
                    oldpassword = user.getPassword();
                }
                Thread.sleep(1000);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

</code></pre></div></div>
<p>通过浏览器访问:http://localhost:8082.  <br />
需要说明的是jdk中并未包含HtmlAdaptorServer类,需要到<a href="http://www.oracle.com/technetwork/java/javasebusiness/downloads/java-archive-downloads-java-plat-419418.html">apache网站</a>下载jmx-1_2_1-ri.zip解压后,将lib文件夹下的两个jar包加入到classpath中.</p>
<ol>
  <li>自己做二次开发
再次修改MBeanTest如下:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MBeanTest {
    public static void main(String[] args) {
        try {
            MBeanServer beanServer = ManagementFactory.getPlatformMBeanServer();
            ObjectName objectName = new ObjectName("jmxdemo:type=User");
            User user = new User();
            beanServer.registerMBean(user, objectName);

            //这个步骤很重要，注册一个端口，绑定url后用于客户端通过rmi方式连接JMXConnectorServer
            LocateRegistry.createRegistry(9999);
            //URL路径的结尾可以随意指定，但如果需要用Jconsole来进行连接，则必须使用jmxrmi
            JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://localhost:9999/jmxrmi");
            JMXConnectorServer jcs = JMXConnectorServerFactory.newJMXConnectorServer(url, null, beanServer);
            jcs.start();
            
            String oldusername = null;
            String oldpassword = null;

            while (true) {
                if (oldusername != user.getUsername() || oldpassword != user.getPassword()) {
                    System.out.println(user.getUsername() + ',' + user.getPassword());
                    oldusername = user.getUsername();
                    oldpassword = user.getPassword();
                }
                Thread.sleep(1000);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre></div></div>

<p>同时新建一个client类:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ClientTest {
    public static void main(String[] args) {
        try {
            JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://localhost:9999/jmxrmi");
            JMXConnector jmxc = JMXConnectorFactory.connect(url, null);
            MBeanServerConnection mbsc = jmxc.getMBeanServerConnection();
            ObjectName mbeanName = new ObjectName("jmxdemo:type=User");
            
            //设置指定Mbean的特定属性值  //这里的setAttribute、getAttribute操作只能针对bean的属性
            //例如对getName或者setName进行操作，只能使用Name，需要去除方法的前缀
            mbsc.setAttribute(mbeanName, new Attribute("Password", "pass"));
            mbsc.setAttribute(mbeanName, new Attribute("Username", "user"));
            String password = (String) mbsc.getAttribute(mbeanName, "Password");
            String username = (String) mbsc.getAttribute(mbeanName, "Username");
            System.out.println("password=" + password + ";username=" + username);

            UserMBean proxy = MBeanServerInvocationHandler.newProxyInstance(mbsc, mbeanName, UserMBean.class, false);
            proxy.test();//在server端(MBeanTest)调用test方法            
            mbsc.invoke(mbeanName, "test", null, null);//在server端(MBeanTest)调用test方法
            //invoke调用bean的方法，只针对非设置属性的方法,不能对get和set方法做调用
            //mbsc.invoke(mbeanName, "getUsername", null, null);//会报错
        } catch (Exception e) {
            System.out.println(e);
        }
    }
}
</code></pre></div></div>
<p>在执行Client的main方法前,在User类中添加方法<code class="highlighter-rouge">public void test(){System.out.println("test!!!");}</code>,同时UserMBean中添加接口<code class="highlighter-rouge">public void test();</code></p>

<p>当然如果没有client类,也可以通过jconsole使用远程访问:
<img src="/_pic/201803/remote-server.png" alt="" /></p>

<h1 id="为什么要用">为什么要用</h1>
<p>JMX有两大功能，一个是提供了对存变量的修改，一个是对内存中java变量的查看.
首先看怎样对内存中的变量做动态修改.目前实现动态修改内存中的变量有多种方式,如每隔特定的时间去某个服务中心拉取变量的值,或者服务中心主动推送值发生变化的变量,并且目前这种方式都可以通过中间件的方式实现,对业务流程无入侵.但这种方式需要对接入系统的框架做适配.
通过JMX则对系统使用的框架没有要求.
Tomcat就是使用了JMX来实现类实例的控制,它通过JmxEnabled和LifecycleMBeanBase来对加载的类做统一的控制,同时LifecycleMBeanBase也管控了Tomcat加载的所有的类的实例.</p>

<p>以上总结了JMX是什么,怎么用,以及什么时候用的问题,感觉还是挺不错的.目前了解到JBOSS是通过JMX来实现的,后边有需要用到的场景的话可以再详细了解下.</p>

<h1 id="参考">参考</h1>
<p><a href="http://www.oracle.com/technetwork/java/javase/tech/best-practices-jsp-136021.html#mozTocId931827">Java Management Extensions</a>  <br />
<a href="http://www.cnblogs.com/dongguacai/p/5900507.html">JMX超详细解读</a></p>

                </article>
                </div>
            </div>
        </div>
    </div>
</div>


<footer class="footer" role="contentinfo">
	<div class="container">
		<div class="footer-col-wrapper">
			<div class="footer-col footer-col-2">
				<ul class="social-media-list">
					
					<li>
						<a href="https://github.com/swa19"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">swa19</span></a>

					</li>
					
				</ul>
			</div>
			<div class="footer-col footer-col-3">
				<p>我不是个伟大的程序员，我只是个有着一些优秀习惯的好程序员--by Kent Beck</p>
			</div>
		</div>
	</div>
</footer>


</body>
</html>