---
layout: post
title:  "做项目踩过的坑"
date:   2018-09-13 21:34:18 +0800
categories: 小结
tags: other
---

# 本地缓存

背景:系统页面需要展示一些列表信息,这些信息通过rpc接口调外部服务获得.同时通过系统页面可以更新这些列表信息.

为了避免远程调用造成的延时和系统开销,考虑增加本地缓存.在涉及到多实例服务器的情况,正常应该采用分布式缓存,但考虑到列表信息的数据比较大,所以采用了最简单的本地缓存.

实施方案:当更新列表信息时,更新redis中指定key的标识;每次获取列表信息时,先从redis获取标识,如果发现值不为空,则更新本地缓存,同时将标识的值置空,表示本地缓存已更新.

所以问题在于:是否更新的标识只有一个,但是本地缓存却有多个(对应多个服务器实例),所以本地缓存无法按照预期实现更新.

最终的解决方案:本地缓存同时维护一个版本号.当更新列表信息时,redis中的标识值修改为当前的时间戳.每次获取列表信息时,检查本地缓存中是否存在版本号,并且当前的这个版本号是否和redis中的版本号一致,如果不一致的话,更新本地缓存,同时更新本地版本号为redis中的版本号.

对于服务器多实例的情况需要做额外考虑,做分布式控制

其他需要考虑的:

* 对于服务器触发的定时任务,需要统一调度
* 通过服务器去触发一个资源几种的操作(如服务器启动时,初始化redis缓存)
